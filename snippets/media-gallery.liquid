{% comment %}
  Renders product media gallery

  Accepts:
  - product: {Object} Product Liquid object (optional)
  - enable_sticky_image: {Boolean} Sticky content when scroll down. Default: true (optional)
  - media_layout: {String} Product media layout type. Values are 'thumbnail_slider', 'stacked', '2_columns'
  - show_thumbnail_desktop: {Boolean} Show thumnail on desktop.
  - show_thumbnail_mobile: {Boolean} Show thumnail on mobile.
  - quick-view: {Boolean} is Quick view.
  - lazy_load: {Boolean} Images should be lazy loaded. Default: true (optional)

  Usage:
  {% render 'media-gallery', lazy_load: false %}
{% endcomment %}
{%- liquid
  assign ratio = 'pb-[100%]' 
  case section.settings.image_ratio
    when "portrait"
      assign ratio = 'pb-[150%]'
    when "landscape"
      assign ratio = 'pb-[75%]'
    when "wide"
      assign ratio = 'pb-[56%]'
    when "3/4"
      assign ratio = 'pb-[133%]'
  endcase

  if section.settings.desktop_layout == "right"
    assign margin_thumbnail = "mr-2 md:mr-0 md:ml-2"
  else  
    assign margin_thumbnail = "mr-2"
  endif
-%}
{%- liquid
  assign video_autoplay = section.settings.enable_video_autoplay
  if media_layout != 'thumbnail_slider'
    assign video_autoplay = false
  endif
  assign page_width = settings.page_width

  assign show_media_with_tag_alt = false
  for media in product.media
    if media.preview_image.alt != blank and show_media_with_variant_selected and media.preview_image.alt contains "#" and show_media_with_tag_alt == false
      assign show_media_with_tag_alt = true
    endif
  endfor
-%}
{%- capture settings -%}
  {
    "section_id": "{{ section.id }}",
    "thumbnail_direction": "{{ section.settings.thumbnail_position }}",
    "video_autoplay": {{ video_autoplay | default: false }},
    "video_loop": {{ section.settings.enable_video_loop | default: false }}
  }
{%- endcapture %}
{%- capture sizes -%}
  (min-width: {{ page_width }}px) {% if section.settings.full_width %}50vw{% else %}{% if section.settings.desktop_media_layout == "2_columns" %}{{ page_width | divided_by: 4 }}px{% else %}{{ page_width | divided_by: 2 }}px{% endif %}{% endif %}, (min-width: 767px) {% if section.settings.desktop_media_layout == "2_columns" %} 25vw{% else %} 50vw{% endif %}, 100vw
{%- endcapture -%}
{%- if lazy_load == false and product.media.first.media_type == 'image' -%}
  <div class="hidden">
    {{ product.media.first.preview_image | image_url: width: 1780 | image_tag: widths: '375, 450, 750, 900, 1100, 1500, 1780', preload: true, sizes: '50vw' }}
  </div>
{%- endif -%}
<div
  id="product-media-{{ section.id }}"
  class="{% if enable_sticky_image %}sticky top-20 quick-view:top-0{% endif %}"
  x-data='xProductMedia({{ settings }})'
  {% if show_media_with_variant_selected and product.has_only_default_variant == false %}
    data-media-with-variant-selected="true"
  {% endif %}
>
  <a href="#ProductInfo-{{ section.id }}" class="skip-to-content absolute -z-10 mt-0.5 ml-0.5 hidden lg:block button button-solid pt-2.5 pb-2.5 pl-6 pr-6 lg:pt-3 lg:pb-3 leading-normal justify-center cursor-pointer focus-visible:z-20">
    {{ 'accessibility.skip_to_product_info' | t }}
  </a>
  <div class="splide-image flex{% if section.settings.thumbnail_position == "horizontal" %} flex-col-reverse{% elsif section.settings.desktop_layout == "right" %} md:flex-row-reverse{% endif %}">
    <div
      id="x-product-thumbnail-{{ section.id }}"
      class="select-none duration-150 overflow-auto hide-scrollbar scroll-smooth {% if product.metafields.custom.show_dots_for_media_slider %}hidden{% endif %} {% if show_thumbnail_desktop and product.media.size > 1 and media_layout == 'thumbnail_slider' %} md:block{% else %} md:hidden{% endif %}{% if section.settings.thumbnail_position == "vertical" %} relative w-[15%] min-w-[45px] md:min-w-[65px] max-w-[90px] lg:min-w-[85px] {{ margin_thumbnail }}{% else %} mt-2{% endif %}"
      x-ref="thumbnail"
      :class="thumbnailGrabbingClass"
      x-on:mousedown="thumbnailHandleMouseDown($event)"
      x-on:mousemove="thumbnailHandleMouseMove($event)"
      x-on:mouseleave="thumbnailHandleMouseLeave()"
      x-on:mouseup="thumbnailHandleMouseUp()"
    >
      <div class="flex flex-1 max-w-full gap-x-2 gap-y-1.5{% if section.settings.thumbnail_position == "vertical" %} flex-col absolute w-full{% else %} w-fit{% endif %}{% if show_thumbnail_mobile and section.settings.thumbnail_position == "horizontal" %} h-17{% endif %}">
        {% if product.media.size > 0 %}
          {% if product.selected_or_first_available_variant.featured_media.id and show_first_image_avaiable %}
            {% liquid assign firstMedia = product.media | where : 'id', product.selected_or_first_available_variant.featured_media.id %}
            {% for media in firstMedia %}
              {% liquid
                assign data_media_type = ""
                if media.preview_image.alt != blank and show_media_with_variant_selected and media.preview_image.alt contains "#"
                  assign data_media_type = media.preview_image.alt | split: "#" | last | prepend: "-" | prepend: media_with_option
                endif
                assign firstMedia = product.media | where : 'id', product.selected_or_first_available_variant.featured_media.id 
              %}
              <div 
                {% if show_media_with_tag_alt %}
                  data-media-option="{{ media_with_option | handle }}"
                  data-media-type="{{ data_media_type }}"
                {% elsif show_media_with_variant_selected and show_media_with_tag_alt == false %}
                  data-media-option="{% if variant_images contains media.src %}{{ section.id }}-{{ media.id }}{% endif %}"
                {% endif %}
                class="x-thumbnail x-thumbnail-{{ section.id }}-{{ media.id }}{% if product.featured_media.id == media.id %} featured-image{% endif %} relative select-none opacity-30{% if section.settings.thumbnail_position == "horizontal" %} min-w-[50px] md:min-w-[65px] lg:min-w-[85px]{% endif %}"
              >
                <button class="relative block w-full h-full pb-[100%]{% if rounded_corner_image %} {% unless mobile_media_full %} rounded-[10px]{% endunless %} md:rounded-[10px] overflow-hidden{% endif %}" aria-label="image-thumbnai">
                  <img
                    src="{{ media.preview_image | image_url: width: 150 }}"
                    alt="{{ media.preview_image.alt | split: "#" | first | escape }}"
                    loading="lazy"
                    width="{{ media.preview_image.width }}"
                    height="{{ media.preview_image.height }}"
                    class="w-full object-cover absolute h-full select-none pointer-events-none"
                  >
                  {%- if media.media_type == 'video' or media.media_type == 'external_video' -%}
                    <div class="absolute top-1/2 -translate-x-1/2 left-1/2 -translate-y-1/2 w-6 h-6">
                      <span class="w-6 h-6 inline-block p-1 bg-[rgba(var(--background-color),1)] rounded-full border">
                        {%- render 'icon-media', icon: 'icon-play' | class: 'w-full h-full' -%}
                      </span>
                    </div>
                  {%- endif -%}
                  {%- if media.media_type == 'model' -%}
                    <div class="absolute top-1/2 -translate-x-1/2 left-1/2 -translate-y-1/2 w-6 h-6">
                      <span class="w-6 h-6 inline-block p-1 bg-[rgba(var(--background-color),1)] rounded-full border">
                        {%- render 'icon-media', icon: 'icon-3d-model' -%}
                      </span>
                    </div>
                  {%- endif -%}
                </button>
              </div>
            {% endfor %}
          {% endif %}
          {% for media in product.media %}
            {% liquid 
              assign data_media_type = ""
              if media.preview_image.alt and show_media_with_variant_selected and media.preview_image.alt contains "#"
                assign data_media_type = media.preview_image.alt | split: "#" | last | prepend: "-" | prepend: media_with_option
              endif
              assign firstMedia = product.media | where : 'id', product.selected_or_first_available_variant.featured_media.id 
            %}
            {% if media.id != product.selected_or_first_available_variant.featured_media.id or show_first_image_avaiable == false %}
              <div 
                {% if show_media_with_tag_alt %}
                  data-media-option="{{ media_with_option | handle }}"
                  data-media-type="{{ data_media_type }}"
                {% elsif show_media_with_variant_selected and show_media_with_tag_alt == false %}
                  data-media-option="{% if variant_images contains media.src %}{{ section.id }}-{{ media.id }}{% endif %}"
                {% endif %}
                class="x-thumbnail x-thumbnail-{{ section.id }}-{{ media.id }}{% if product.featured_media.id == media.id %} featured-image{% endif %} relative select-none opacity-30{% if section.settings.thumbnail_position == "horizontal" %} min-w-[50px] md:min-w-[65px] lg:min-w-[85px]{% endif %}"
              >
                <button class="relative block w-full h-full pb-[100%]{% if rounded_corner_image %} {% unless mobile_media_full %} rounded-[10px]{% endunless %} md:rounded-[10px] overflow-hidden{% endif %}" aria-label="image-thumbnai">
                  <img
                    src="{{ media.preview_image | image_url: width: 150 }}"
                    alt="{{ media.preview_image.alt | split: "#" | first | escape }}"
                    loading="lazy"
                    width="{{ media.preview_image.width }}"
                    height="{{ media.preview_image.height }}"
                    class="w-full object-cover absolute h-full select-none pointer-events-none"
                  >
                  {%- if media.media_type == 'video' or media.media_type == 'external_video' -%}
                    <div class="absolute top-1/2 -translate-x-1/2 left-1/2 -translate-y-1/2 w-6 h-6">
                      <span class="w-6 h-6 inline-block p-1 bg-[rgba(var(--background-color),1)] rounded-full border">
                        {%- render 'icon-media', icon: 'icon-play' | class: 'w-full h-full' -%}
                      </span>
                    </div>
                  {%- endif -%}
                  {%- if media.media_type == 'model' -%}
                    <div class="absolute top-1/2 -translate-x-1/2 left-1/2 -translate-y-1/2 w-6 h-6">
                      <span class="w-6 h-6 inline-block p-1 bg-[rgba(var(--background-color),1)] rounded-full border">
                        {%- render 'icon-media', icon: 'icon-3d-model' -%}
                      </span>
                    </div>
                  {%- endif -%}
                </button>
              </div>
            {% endif %}
          {% endfor %}
        {% else %}
          <div class="x-thumbnail relative opacity-30{% if section.settings.thumbnail_position == "horizontal" %} min-w-[50px] md:min-w-[65px] lg:min-w-[85px]{% endif %}">
            <div class="relative pb-[100%]">
              {% render 'icon-placeholder', icon: 'icon-product' | class: 'bg-[#c9c9c9] w-full h-full absolute' %}
            </div>
          </div>
        {% endif %}
      </div>
    </div>
    <div
      id="x-product-{{ section.id }}"
      class="x-splide disable-effect-hover flex-1 group splide swiper-product overflow-hidden visible{% if media_layout != 'thumbnail_slider' %} md:hidden{% endif %}{% if section.settings.thumbnail_position == "vertical" and show_thumbnail_desktop and product.media.size > 1 %} md:w-[85%]{% endif %}{% if section.settings.thumbnail_position == "vertical" and show_thumbnail_mobile and product.media.size > 1 %} w-[85%]{% else %} w-full{% endif %}"
      {% if show_media_with_variant_selected and product.has_only_default_variant == false %}
      x-init='document.addEventListener("reload-thumbnail-{{ section.id }}", () => { 
        let splideEl = document.getElementById("x-product-{{ section.id }}");
        if (splideEl.splide) splideEl.splide.destroy();
        $store.xSplide.load($el, {
          "pagination": false,
          "perPage": 1,
          "perMove": 1,
          "gap": 20,
          "type": "fade",
          "noDrag": "model-viewer",
          {% if show_thumbnail_desktop or show_thumbnail_mobile %}
            "thumbs": "x-product-thumbnail-{{ section.id }}",
            "thumbs_direction": "{{ section.settings.thumbnail_position }}",
          {% endif %}
        })
      })'
      {% else %}
        {% if product.metafields.custom.show_dots_for_media_slider %}
          x-intersect.once='$store.xSplide.load($el, {
          "pagination": true,
          "perPage": 1,
          "perMove": 1,
          "gap": 20,
          "type": "fade",          
          {% if product.metafields.custom.autoplay_speed != blank and product.metafields.custom.autoplay_media_slider != blank %}
          "autoplay": {{ product.metafields.custom.autoplay_media_slider }},             // Enable autoplay
          "interval": {{ product.metafields.custom.autoplay_speed | times: 1000 }},             // Autoplay interval (5 seconds)
          "pauseOnHover": true,         // Pause autoplay on hover
          "pauseOnFocus": true,  
          "rewind": true, 
          {% endif %}
          "noDrag": "model-viewer", 
          {% if show_thumbnail_desktop or show_thumbnail_mobile %}
            "thumbs": "x-product-thumbnail-{{ section.id }}",
            "thumbs_direction": "{{ section.settings.thumbnail_position }}",
          {% endif %}
          "events": [
            {
              "event": "ready",
              "callback": () => {
                document.dispatchEvent(new CustomEvent("eurus:media-gallery-ready:{{ section.id }}"));
                const splideEl = document.getElementById("x-product-{{ section.id }}");
                const pagination = splideEl.querySelectorAll(".splide__pagination li");
                
                // Mark the first dot as active
                if (pagination.length) {
                  pagination[0].classList.add("is-active");
                }
              }
            },
            {
              "event": "move",
              "callback": () => {
                const splideEl = document.getElementById("x-product-{{ section.id }}");
                const externalVideos = splideEl.getElementsByClassName("external-video");
                /** prevent instersect trigger */
                if (externalVideos.length) {
                  for (let i = 0; i < externalVideos.length; i++) {
                    externalVideos[i].classList.add("hidden");
                  }
                }
              }
            },
            {
              "event": "moved",
              "callback": (newIndex) => {
                const splideEl = document.getElementById("x-product-{{ section.id }}");
                const externalVideos = splideEl.getElementsByClassName("external-video");
                /** back to normal */
                if (externalVideos.length) {
                  for (let i = 0; i < externalVideos.length; i++) {
                    externalVideos[i].classList.remove("hidden");
                  }
                }

                const pagination = splideEl.querySelectorAll(".splide__pagination li");
                
                pagination.forEach(li => li.classList.remove("is-active"));        
                if (pagination[newIndex]) {
                  pagination[newIndex].classList.add("is-active");
                }
              }
            }
          ]
        })'
        {% else %}
          x-intersect.once='$store.xSplide.load($el, {
          "pagination": false,
          "perPage": 1,
          "perMove": 1,
          "gap": 20,
          "type": "fade",
          {% if product.metafields.custom.autoplay_speed != blank and product.metafields.custom.autoplay_media_slider != blank %}
          "autoplay": {{ product.metafields.custom.autoplay_media_slider }},             // Enable autoplay
          "interval": {{ product.metafields.custom.autoplay_speed | times: 1000 }},             // Autoplay interval (5 seconds)
          "pauseOnHover": true,         // Pause autoplay on hover
          "pauseOnFocus": true,  
          "rewind": true, 
          {% endif %}
          "pauseOnFocus": true,  
          "noDrag": "model-viewer", 
          {% if show_thumbnail_desktop or show_thumbnail_mobile %}
            "thumbs": "x-product-thumbnail-{{ section.id }}",
            "thumbs_direction": "{{ section.settings.thumbnail_position }}",
          {% endif %}
          "events": [
            {
              "event": "ready",
              "callback": () => {
                document.dispatchEvent(new CustomEvent("eurus:media-gallery-ready:{{ section.id }}"));                
              }
            },
            {
              "event": "move",
              "callback": () => {
                const splideEl = document.getElementById("x-product-{{ section.id }}");
                const externalVideos = splideEl.getElementsByClassName("external-video");
                /** prevent instersect trigger */
                if (externalVideos.length) {
                  for (let i = 0; i < externalVideos.length; i++) {
                    externalVideos[i].classList.add("hidden");
                  }
                }
              }
            },
            {
              "event": "moved",
              "callback": (newIndex) => {
                const splideEl = document.getElementById("x-product-{{ section.id }}");
                const externalVideos = splideEl.getElementsByClassName("external-video");
                /** back to normal */
                if (externalVideos.length) {
                  for (let i = 0; i < externalVideos.length; i++) {
                    externalVideos[i].classList.remove("hidden");
                  }
                }
              }
            }
          ]
        })'
        {% endif %}
        
      {% endif %}
    >
      <div class="splide__track">
        <div id="media_product-{{ section.id }}" class="splide__list flex">
          {% if product.media.size > 0 %}
            {%- assign mediaIndex = 1 -%}
            {% if product.selected_or_first_available_variant.featured_media.id and show_first_image_avaiable %}
              {% liquid assign firstMedia = product.media | where : 'id', product.selected_or_first_available_variant.featured_media.id %}
              {% for media in firstMedia %}
                {%- render 'media',
                  product: product,
                  media: media,
                  zoom_full: section.settings.enable_image_zoom,
                  index: mediaIndex,
                  ratio: ratio,
                  lazy_load: lazy_load,
                  media_layout: 'thumbnail_slider',
                  video_autoplay: video_autoplay,
                  rounded_corner_image: rounded_corner_image,
                  mobile_media_full: mobile_media_full,
                  sizes: sizes,
                  show_media_with_variant_selected: show_media_with_variant_selected,
                  media_with_option: media_with_option,
                  variant_images: variant_images,
                  show_media_with_tag_alt: show_media_with_tag_alt
                -%}
                {%- assign mediaIndex = mediaIndex | plus: 1 -%}
              {% endfor %}
            {% endif %}
            {% for media in product.media %}
              {% if media.id != product.selected_or_first_available_variant.featured_media.id or show_first_image_avaiable == false %}
                {%- render 'media',
                  product: product,
                  media: media,
                  zoom_full: section.settings.enable_image_zoom,
                  index: mediaIndex,
                  ratio: ratio,
                  lazy_load: lazy_load,
                  media_layout: 'thumbnail_slider',
                  video_autoplay: video_autoplay,
                  rounded_corner_image: rounded_corner_image,
                  mobile_media_full: mobile_media_full,
                  sizes: sizes,
                  show_media_with_variant_selected: show_media_with_variant_selected,
                  media_with_option: media_with_option,
                  variant_images: variant_images,
                  show_media_with_tag_alt: show_media_with_tag_alt
                -%}
                {%- assign mediaIndex = mediaIndex | plus: 1 -%}
              {% endif %}
            {% endfor %}
          {% else %}
            <div data-type="image" class="splide__slide x-splide-slide product-media product-media--image featured-image" index="0">     
              <div class="relative overflow-hidden {{ ratio }}">
                {% render 'icon-placeholder', icon: 'icon-product', class: 'bg-[#c9c9c9] text-[#acacac] w-full h-full absolute top-0 left-0' %}
              </div>
            </div>
          {% endif %}
        </div>
      </div>
      {% if show_thumbnail_desktop and show_arrow_button %}
        <div class="splide__arrows md:mb-2 mb-1 md:mt-4 mt-3 flex justify-center w-full {% if product.metafields.custom.show_dots_for_media_slider %}hidden-phone-themebased{% endif %} items-center lg:mb-0 lg:mt-0 md:hidden pointer-events-none{% if show_thumbnail_mobile %} hidden{% endif %}{% if product.media.size < 2 %} hidden{% else %} lg:block{% endif %}">
          <button class="splide__arrow p-3 md:pt-0 md:pb-0 md:pl-0 md:pr-0 lg:absolute lg:left-0 rtl:lg:group-hover:left-4 lg:top-0 lg:bottom-0 opacity-60 transition-all ease-in-out lg:opacity-0 lg:group-hover:opacity-60 lg:group-hover:translate-x-2 lg:-translate-x-full z-10 lg:group-hover:disabled:opacity-30 disabled:opacity-30 disabled:cursor-not-allowed pointer-events-auto items-center justify-center duration-200 splide__arrow--prev rounded-full" aria-label="Go to last slide">
            <span class="w-12 h-12 not-icon rounded-full button button-arrow p-4 rotate-90 hidden md:block">{% render 'icon-alls', icon: 'icon-caret' %}</span>
            <span class="w-4 h-4 rotate-90 block md:hidden">{% render 'icon-alls', icon: 'icon-caret' %}</span>
          </button>
          <div class="h-5 border-l-2 w-0 ml-1 mr-1 lg:hidden"></div>
          <button class="splide__arrow p-3 md:pt-0 md:pb-0 md:pl-0 md:pr-0 lg:absolute lg:right-0 rtl:lg:group-hover:right-4 lg:top-0 lg:bottom-0 opacity-60 transition-all ease-in-out lg:opacity-0 lg:group-hover:opacity-60 lg:group-hover:-translate-x-2 lg:translate-x-full z-10 lg:group-hover:disabled:opacity-30 disabled:opacity-30 disabled:cursor-not-allowed pointer-events-auto items-center justify-center duration-200 splide__arrow--next rounded-full" aria-label="Next slide">
            <span class="w-12 h-12 not-icon -rotate-90 rounded-full button button-arrow p-4 hidden md:block">{% render 'icon-alls', icon: 'icon-caret' %}</span>
            <span class="w-4 h-4 -rotate-90 block md:hidden">{% render 'icon-alls', icon: 'icon-caret' %}</span>
          </button>
        </div>
        {% if product.metafields.custom.show_dots_for_media_slider %}
        <ul class="splide__pagination md:mb-2 md:mt-4 mt-3 flex justify-center hidden-tablet-and-up-themebased w-full items-center {% if show_thumbnail_desktop or show_arrow_button == false %} md:hidden{% endif %}{% if show_thumbnail_mobile %} hidden{% endif %}{% if product.media.size < 2 %} hidden{% endif %}">
          
        </ul>
        {% endif %}
      {% else %}
        <div class="splide__arrows md:mb-2 mb-1 md:mt-4 mt-3 flex justify-center w-full items-center {% if show_thumbnail_desktop or show_arrow_button == false %} md:hidden{% endif %}{% if show_thumbnail_mobile %} hidden{% endif %}{% if product.media.size < 2 %} hidden{% endif %}">
          <button class="splide__arrow flex p-3 w-11 h-11 z-10 disabled:opacity-30 disabled:cursor-not-allowed opacity-60 items-center justify-center duration-200 splide__arrow--prev rotate-90 rounded-full" aria-label="Go to last slide">
            {% render 'icon-alls', icon: 'icon-caret' %}
          </button>
          <div class="h-5 border-l-2 w-0 ml-1 mr-1"></div>
          <button class="splide__arrow flex p-3 w-11 h-11 z-10 disabled:opacity-30 disabled:cursor-not-allowed opacity-60 items-center justify-center duration-200 splide__arrow--next -rotate-90 rounded-full" aria-label="Next slide">
            {% render 'icon-alls', icon: 'icon-caret' %}
          </button>
        </div>
      {% endif %}
    </div>
    {% if media_layout != 'thumbnail_slider' %}
      <div 
        class="flex-wrap gap-2.5 hidden md:flex w-full h-full" 
        id="stacked-{{ section.id }}"
      >
        {% if product.media.size > 0 %}
          {%- assign mediaIndex = 1 -%}
          {% if product.selected_or_first_available_variant.featured_media.id and show_first_image_avaiable %}
            {% liquid assign firstMedia = product.media | where : 'id', product.selected_or_first_available_variant.featured_media.id %}
            {% for media in firstMedia %}
              {% liquid 
                assign data_media_type = ""
                if media.preview_image.alt != blank and show_media_with_variant_selected and media.preview_image.alt contains "#"
                  assign data_media_type = media.preview_image.alt | split: "#" | last | prepend: "-" | prepend: media_with_option
                endif
              %}
              <div 
                id="postion-image-{{ section.id }}-{{ media.id }}"
                class="product-media-item w-[calc(50%-5px)] postion-image-{{ section.id }}{% if product.featured_media.id == media.id %} featured-image{% endif %}{% if media_layout == 'stacked' %} first:w-full{% endif %}" 
                data-media-id="{{ section.id }}-{{ media.id }}"
                data-index="{{ mediaIndex }}" 
                {% if show_media_with_tag_alt %}
                  data-media-option="{{ media_with_option | handle }}"
                  data-media-type="{{ data_media_type }}"
                {% elsif show_media_with_variant_selected and show_media_with_tag_alt == false %}
                  data-media-option="{% if variant_images contains media.src %}{{ section.id }}-{{ media.id }}{% endif %}"
                {% endif %}
               >
                {%- render 'media', 
                  media: media,
                  zoom_full: section.settings.enable_image_zoom,
                  forindex: mediaIndex,
                  stacked: true,
                  ratio: ratio,
                  lazy_load: lazy_load,
                  media_layout: media_layout,
                  video_autoplay: video_autoplay,
                  rounded_corner_image: rounded_corner_image,
                  mobile_media_full: mobile_media_full,
                  sizes: sizes,
                  show_media_with_variant_selected: show_media_with_variant_selected,
                  media_with_option: media_with_option,
                  variant_images: variant_images,
                  show_media_with_tag_alt: show_media_with_tag_alt
                -%}
                {%- assign mediaIndex = mediaIndex | plus: 1 -%}
              </div>
            {% endfor %}
          {% endif %}
          {% for media in product.media %}
            {% liquid 
              assign data_media_type = ""
              if media.preview_image.alt != blank and show_media_with_variant_selected and media.preview_image.alt contains "#"
                assign data_media_type = media.preview_image.alt | split: "#" | last | prepend: "-" | prepend: media_with_option
              endif
              assign firstMedia = product.media | where : 'id', product.selected_or_first_available_variant.featured_media.id 
            %}
            {% if media.id != product.selected_or_first_available_variant.featured_media.id or show_first_image_avaiable == false %}
              <div
                id="postion-image-{{ section.id }}-{{ media.id }}"
                class="product-media-item w-[calc(50%-5px)] postion-image-{{ section.id }}{% if product.featured_media.id == media.id %} featured-image{% endif %}{% if media_layout == 'stacked' %} first:w-full{% endif %}" 
                data-media-id="{{ section.id }}-{{ media.id }}"
                data-index="{{ mediaIndex }}" 
                {% if show_media_with_tag_alt %}
                  data-media-option="{{ media_with_option | handle }}"
                  data-media-type="{{ data_media_type }}"
                {% elsif show_media_with_variant_selected and show_media_with_tag_alt == false %}
                  data-media-option="{% if variant_images contains media.src %}{{ section.id }}-{{ media.id }}{% endif %}"
                {% endif %}
              >
                {%- render 'media', 
                  media: media,
                  zoom_full: section.settings.enable_image_zoom,
                  forindex: mediaIndex,
                  stacked: true,
                  ratio: ratio,
                  lazy_load: lazy_load,
                  media_layout: media_layout,
                  video_autoplay: video_autoplay,
                  rounded_corner_image: rounded_corner_image,
                  mobile_media_full: mobile_media_full,
                  sizes: sizes,
                  show_media_with_variant_selected: show_media_with_variant_selected,
                  media_with_option: media_with_option,
                  variant_images: variant_images,
                  show_media_with_tag_alt: show_media_with_tag_alt
                -%}
                {%- assign mediaIndex = mediaIndex | plus: 1 -%}
              </div>
            {% endif %}
          {% endfor %}
        {% else %}
          <div data-type="image" class="product-media product-media--image w-full">      
            <div class="relative overflow-hidden" >
              {{ 'product-1' | placeholder_svg_tag: 'bg-neutral-200 w-full h-full' }}
            </div>
          </div>
        {% endif %}
      </div>
    {% endif %}
    {% if section.settings.enable_image_zoom %}
      <template x-teleport="body">
        <div
          id="ProductModal-{{ section.id }}"
          class="fixed top-0 left-0 w-full h-full z-50 bg-[rgba(var(--background-color),1)] overflow-y-scroll scrollbar-body"
          x-show="zoomIsOpen"
          x-transition:enter="transition-all ease-in-out duration-300"
          x-transition:enter-start="opacity-0 transform md:-translate-x-1/3 translate-y-1/3 md:translate-y-0"
          x-transition:enter-end="opacity-100 transform md:translate-x-0 translate-y-0"
          x-transition:leave="transition-all ease-in-out duration-300"
          x-transition:leave-end="opacity-0 transform md:translate-x-1/3 translate-y-1/3 md:translate-y-0"
          x-intersect:leave="$store.xModal.removeFocus('postion-image-{{ section.id }}-{{ media.id }}')"
          @keyup.escape="zoomClose()"
        >
          <div 
            id="zoom-x-product-{{ section.id }}" 
            class="w-full ml-auto mr-auto" 
            tabindex="-1" 
            role="dialog" 
            aria-modal="true" 
            aria-label="{{ 'products.modal.label' | t }}"
          >
            <div class="fixed top-4 right-4 overflow-hidden rounded-full z-50">
              <button 
                id="ProductModalClose-{{ section.id }}"
                @click="zoomClose()" 
                class="button p-2.5 md:p-4 w-8 button-action h-8 md:w-12 md:h-12 rounded-full hover:border-0"
                x-intersect.full="$store.xModal.focus('ProductModal-{{ section.id }}', 'ProductModalClose-{{ section.id }}');"
                aria-label="close-zoom"
              >
                {% render 'icon-alls', icon: 'icon-close' %}
              </button>
            </div>
            <div class="block">
              {% if product.selected_or_first_available_variant.featured_media.id and show_first_image_avaiable %}
                {% liquid assign firstMedia = product.media | where : 'id', product.selected_or_first_available_variant.featured_media.id %}
                {% for media in firstMedia %}
                  {% liquid 
                    assign data_media_type = ""
                    if media.preview_image.alt != blank and show_media_with_variant_selected and media.preview_image.alt contains "#"
                      assign data_media_type = media.preview_image.alt | split: "#" | last | prepend: "-" | prepend: media_with_option
                    endif
                  %}
                  <div 
                    id="{{ media.position }}-image-zoom-{{ section.id }}" 
                    class="mb-3"
                    {% if show_media_with_tag_alt %}
                      data-media-option="{{ media_with_option | handle }}"
                      data-media-type="{{ data_media_type }}"
                    {% elsif show_media_with_variant_selected and show_media_with_tag_alt == false %}
                      data-media-option="{% if variant_images contains media.src %}{{ section.id }}-{{ media.id }}{% endif %}"
                    {% endif %}
                  >
                    <div class="flex justify-center items-center">
                      {% case media.media_type %}
                        {% when 'image' %}
                          <img
                            srcset="{{ media.preview_image | image_url: width: 375 }} 375w,
                            {{ media.preview_image | image_url: width: 450 }} 450w,
                            {{ media.preview_image | image_url: width: 750 }} 750w,
                            {{ media.preview_image | image_url: width: 900 }} 900w,
                            {{ media.preview_image | image_url: width: 1100 }} 1100w,
                            {{ media.preview_image | image_url: width: 1500 }} 1500w,
                            {{ media.preview_image | image_url: width: 1780 }} 1780w,
                            {{ media.preview_image | image_url: width: 2000 }} 2000w,
                            {{ media.preview_image | image_url: width: 3000 }} 3000w,
                            {{ media.preview_image | image_url: width: 3840 }} 3840w,
                            {{ media.preview_image | image_url }} {{ media.preview_image.width }}w"
                            src="{{ media.preview_image | image_url: width: 1200 }}"
                            alt="{{ media.preview_image.alt | split: "#" | first | escape }}"
                            loading="lazy"
                            sizes="100vw"
                            width="{{ media.preview_image.width }}"
                            height="{{ media.preview_image.height }}"
                            class="w-full object-contain"
                          > 
                        {% when 'video' %}
                          <div class="w-full" x-intersect:leave="$store.xVideo.pause($el)">
                          {{ media | media_tag: image_size: '1024x', autoplay: false, loop: section.settings.enable_video_loop, controls: true, loading: 'lazy', class: 'w-full video' }}
                          </div>
                          <script src="{{ 'video.js' | asset_url }}" defer></script>
                        {% when 'external_video' %}
                          {%- if media.host == 'youtube' -%}
                            <div x-intersect:leave="$store.xVideo.pause($el)" class="external-video w-full relative pb-[50%] h-0">
                              {% comment %}theme-check-disable RemoteAsset{% endcomment %}
                              <picture
                                class="cursor-pointer w-full h-full absolute top-0 left-0 video">
                                <source type="image/webp" srcset="{{ media.external_id | prepend: 'https://i.ytimg.com/vi_webp/' | append: '/maxresdefault.webp' }}">
                                <source type="image/jpeg" srcset="{{ media.external_id | prepend: 'https://i.ytimg.com/vi_webp/' | append: '/maxresdefault.webp' }}">
                                <img src="{{ media.external_id | prepend: 'https://i.ytimg.com/vi_webp/' | append: '/maxresdefault.webp' }}" loading="lazy" class="w-full h-full object-cover" alt="{{ product.title | escape }}" width="512" height="288"/>
                              </picture>
                              {% comment %}theme-check-enable RemoteAsset{% endcomment %}
                              <button 
                                class="button-play absolute z-20 top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-16 h-16 md:w-24 md:h-24 rounded-full p-5 bg-[rgba(var(--image-treatment-text),0.3)] bg-opacity-30 disabled:cursor-not-allowed"
                                @click.prevent="$store.xVideo.externalLoad($el, 'youtube', '{{ media.external_id }}', false, 'video-zoom-product')"
                                aria-label="image-cover"
                              >
                                <span class="pointer-events-none duration-200 icon-button-play bg-button-play absolute w-6 h-6 md:w-10 md:h-10 top-1/2 left-1/2 -translate-y-1/2 -translate-x-1/2 text-[rgba(var(--image-treatment-text))]">
                                  {% render 'icon-media', icon: 'icon-play', class: 'w-full h-full' %}
                                </span>
                              </button>
                            </div>
                          {%- else -%}
                            {%- capture options -%}
                              {
                                'alt': '{{ media.preview_image | default: product.title | escape }}',
                                'width': 1280
                              }
                            {%- endcapture -%}
                            <div x-intersect:leave="$store.xVideo.pause($el)" class="external-video w-full relative pb-[50%] h-0 overflow-hidden">
                              <div x-intersect="$store.xVideo.renderVimeoFacade($el, '{{ media.external_id }}', {{ options }})"></div>
                              <button 
                                class="button-play absolute z-20 top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-16 h-16 md:w-24 md:h-24 rounded-full p-5 bg-[rgba(var(--image-treatment-text),0.3)] bg-opacity-30 disabled:cursor-not-allowed"
                                @click.prevent="$store.xVideo.externalLoad($el, 'vimeo', '{{ media.external_id }}', false, 'video-zoom-product')"
                                aria-label="image-cover"
                              >
                                <span class="pointer-events-none duration-200 icon-button-play bg-button-play absolute w-6 h-6 md:w-10 md:h-10 top-1/2 left-1/2 -translate-y-1/2 -translate-x-1/2 text-[rgba(var(--image-treatment-text))]">
                                  {% render 'icon-media', icon: 'icon-play', class: 'w-full h-full' %}
                                </span>
                              </button>
                            </div>    
                          {%- endif -%}
                          <script src="{{ 'video.js' | asset_url }}" defer></script>
                        {% when 'model' %}
                          <div class="w-full">
                            <div class="relative h-0 w-full pb-[100%] lg:pb-[55%]">
                              <button
                                type="button"
                                data-media-id="{{ media.id }}"
                                @click="productModelLoadMedia"
                                class="absolute top-0 left-0 right-0 bottom-0"
                              >
                                <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2">
                                  <span class="w-12 h-12 lg:w-16 lg:h-16 inline-block lg:p-4 p-2 bg-[rgba(var(--background-color),1)] rounded-full border">
                                    {%- render 'icon-media', icon: 'icon-3d-model' -%}
                                  </span>
                                </div>
                                <img
                                  srcset="{{ media.preview_image | image_url: width: 375 }} 375w,
                                  {{ media.preview_image | image_url: width: 450 }} 450w,
                                  {{ media.preview_image | image_url: width: 750 }} 750w,
                                  {{ media.preview_image | image_url: width: 900 }} 900w,
                                  {{ media.preview_image | image_url: width: 1100 }} 1100w,
                                  {{ media.preview_image | image_url: width: 1500 }} 1500w,
                                  {{ media.preview_image | image_url: width: 1780 }} 1780w,
                                  {{ media.preview_image | image_url: width: 2000 }} 2000w,
                                  {{ media.preview_image | image_url: width: 3000 }} 3000w,
                                  {{ media.preview_image | image_url: width: 3840 }} 3840w,
                                    {{ media.preview_image | image_url }} {{ media.preview_image.width }}w"
                                  src="{{ media | image_url: width: 1920 }}"
                                  sizes="100vw"
                                  loading="lazy"
                                  width="{{ media.preview_image.width }}"
                                  height="{{ media.preview_image.height }}"
                                  alt="{{ media.preview_image.alt | split: "#" | first | escape }}"
                                  class="w-full h-full object-cover"
                                >
                              </button>
                              <template>
                                {{ media | media_tag: image_size: "2048x", toggleable: true }}
                              </template>
                              <button
                                class="button button--full-width product__xr-button hidden"
                                type="button"
                                aria-label="{{ 'products.product.xr_button_label' | t }}"
                                data-shopify-xr
                                data-shopify-model3d-id="{{ media.id }}"
                                data-shopify-title="title"
                                data-shopify-xr-hidden
                              >
                                {% render 'icon-media', icon: 'icon-3d-model' %}
                                {{ 'products.product.xr_button' | t }}
                              </button>
                            </div>
                          </div>
                      {% endcase %}
                    </div>
                  </div>
                {% endfor %}
              {% endif %} 
              {% for media in product.media %}
                {% liquid 
                  assign data_media_type = ""
                  if media.preview_image.alt != blank and show_media_with_variant_selected and media.preview_image.alt contains "#"
                    assign data_media_type = media.preview_image.alt | split: "#" | last | prepend: "-" | prepend: media_with_option
                  endif
                %}
                {% if media.id != product.selected_or_first_available_variant.featured_media.id or show_first_image_avaiable == false %}
                  <div 
                    id="{{ media.position }}-image-zoom-{{ section.id }}" 
                    class="mb-3"
                    {% if show_media_with_tag_alt %}
                      data-media-option="{{ media_with_option | handle }}"
                      data-media-type="{{ data_media_type }}"
                    {% elsif show_media_with_variant_selected and show_media_with_tag_alt == false %}
                      data-media-option="{% if variant_images contains media.src %}{{ section.id }}-{{ media.id }}{% endif %}"
                    {% endif %}
                  >
                    <div class="flex justify-center items-center">
                      {% case media.media_type %}
                        {% when 'image' %}
                          <img
                            srcset="{{ media.preview_image | image_url: width: 375 }} 375w,
                            {{ media.preview_image | image_url: width: 450 }} 450w,
                            {{ media.preview_image | image_url: width: 750 }} 750w,
                            {{ media.preview_image | image_url: width: 900 }} 900w,
                            {{ media.preview_image | image_url: width: 1100 }} 1100w,
                            {{ media.preview_image | image_url: width: 1500 }} 1500w,
                            {{ media.preview_image | image_url: width: 1780 }} 1780w,
                            {{ media.preview_image | image_url: width: 2000 }} 2000w,
                            {{ media.preview_image | image_url: width: 3000 }} 3000w,
                            {{ media.preview_image | image_url: width: 3840 }} 3840w,
                            {{ media.preview_image | image_url }} {{ media.preview_image.width }}w"
                            src="{{ media.preview_image | image_url: width: 1200 }}"
                            alt="{{ media.preview_image.alt | split: "#" | first | escape }}"
                            loading="lazy"
                            sizes="100vw"
                            width="{{ media.preview_image.width }}"
                            height="{{ media.preview_image.height }}"
                            class="w-full object-contain"
                          > 
                        {% when 'video' %}
                          <div class="w-full" x-intersect:leave="$store.xVideo.pause($el)">
                          {{ media | media_tag: image_size: '1024x', autoplay: false, loop: section.settings.enable_video_loop, controls: true, loading: 'lazy', class: 'w-full video' }}
                          </div>
                          <script src="{{ 'video.js' | asset_url }}" defer></script>
                        {% when 'external_video' %}
                          {%- if media.host == 'youtube' -%}
                            <div x-intersect:leave="$store.xVideo.pause($el)" class="external-video w-full relative pb-[50%] h-0">
                              {% comment %}theme-check-disable RemoteAsset{% endcomment %}
                              <picture
                                class="cursor-pointer w-full h-full absolute top-0 left-0 video">
                                <source type="image/webp" srcset="{{ media.external_id | prepend: 'https://i.ytimg.com/vi_webp/' | append: '/maxresdefault.webp' }}">
                                <source type="image/jpeg" srcset="{{ media.external_id | prepend: 'https://i.ytimg.com/vi_webp/' | append: '/maxresdefault.webp' }}">
                                <img src="{{ media.external_id | prepend: 'https://i.ytimg.com/vi_webp/' | append: '/maxresdefault.webp' }}" loading="lazy" class="w-full h-full object-cover" alt="{{ product.title | escape }}" width="512" height="288"/>
                              </picture>
                              {% comment %}theme-check-enable RemoteAsset{% endcomment %}
                              <button 
                                class="button-play absolute z-20 top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-16 h-16 md:w-24 md:h-24 rounded-full p-5 bg-[rgba(var(--image-treatment-text),0.3)] bg-opacity-30 disabled:cursor-not-allowed"
                                @click.prevent="$store.xVideo.externalLoad($el, 'youtube', '{{ media.external_id }}', false, 'video-zoom-product')"
                                aria-label="image-cover"
                              >
                                <span class="pointer-events-none duration-200 icon-button-play bg-button-play absolute w-6 h-6 md:w-10 md:h-10 top-1/2 left-1/2 -translate-y-1/2 -translate-x-1/2 text-[rgba(var(--image-treatment-text))]">
                                  {% render 'icon-media', icon: 'icon-play', class: 'w-full h-full' %}
                                </span>
                              </button>
                            </div>
                          {%- else -%}
                            {%- capture options -%}
                              {
                                'alt': '{{ media.preview_image | default: product.title | escape }}',
                                'width': 1280
                              }
                            {%- endcapture -%}
                            <div x-intersect:leave="$store.xVideo.pause($el)" class="external-video w-full relative pb-[50%] h-0 overflow-hidden">
                              <div x-intersect="$store.xVideo.renderVimeoFacade($el, '{{ media.external_id }}', {{ options }})"></div>
                              <button 
                                class="button-play absolute z-20 top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-16 h-16 md:w-24 md:h-24 rounded-full p-5 bg-[rgba(var(--image-treatment-text),0.3)] bg-opacity-30 disabled:cursor-not-allowed"
                                @click.prevent="$store.xVideo.externalLoad($el, 'vimeo', '{{ media.external_id }}', false, 'video-zoom-product')"
                                aria-label="image-cover"
                              >
                                <span class="pointer-events-none duration-200 icon-button-play bg-button-play absolute w-6 h-6 md:w-10 md:h-10 top-1/2 left-1/2 -translate-y-1/2 -translate-x-1/2 text-[rgba(var(--image-treatment-text))]">
                                  {% render 'icon-media', icon: 'icon-play', class: 'w-full h-full' %}
                                </span>
                              </button>
                            </div>    
                          {%- endif -%}
                          <script src="{{ 'video.js' | asset_url }}" defer></script>
                        {% when 'model' %}
                          <div class="w-full">
                            <div class="relative h-0 w-full pb-[100%] lg:pb-[55%]">
                              <button
                                type="button"
                                data-media-id="{{ media.id }}"
                                @click="productModelLoadMedia"
                                class="absolute top-0 left-0 right-0 bottom-0"
                              >
                                <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2">
                                  <span class="w-12 h-12 lg:w-16 lg:h-16 inline-block lg:p-4 p-2 bg-[rgba(var(--background-color),1)] rounded-full border">
                                    {%- render 'icon-media', icon: 'icon-3d-model' -%}
                                  </span>
                                </div>
                                <img
                                  srcset="{{ media.preview_image | image_url: width: 375 }} 375w,
                                  {{ media.preview_image | image_url: width: 450 }} 450w,
                                  {{ media.preview_image | image_url: width: 750 }} 750w,
                                  {{ media.preview_image | image_url: width: 900 }} 900w,
                                  {{ media.preview_image | image_url: width: 1100 }} 1100w,
                                  {{ media.preview_image | image_url: width: 1500 }} 1500w,
                                  {{ media.preview_image | image_url: width: 1780 }} 1780w,
                                  {{ media.preview_image | image_url: width: 2000 }} 2000w,
                                  {{ media.preview_image | image_url: width: 3000 }} 3000w,
                                  {{ media.preview_image | image_url: width: 3840 }} 3840w,
                                    {{ media.preview_image | image_url }} {{ media.preview_image.width }}w"
                                  src="{{ media | image_url: width: 1920 }}"
                                  sizes="100vw"
                                  loading="lazy"
                                  width="{{ media.preview_image.width }}"
                                  height="{{ media.preview_image.height }}"
                                  alt="{{ media.preview_image.alt | split: "#" | first | escape }}"
                                  class="w-full h-full object-cover"
                                >
                              </button>
                              <template>
                                {{ media | media_tag: image_size: "2048x", toggleable: true }}
                              </template>
                              <button
                                class="button button--full-width product__xr-button hidden"
                                type="button"
                                aria-label="{{ 'products.product.xr_button_label' | t }}"
                                data-shopify-xr
                                data-shopify-model3d-id="{{ media.id }}"
                                data-shopify-title="title"
                                data-shopify-xr-hidden
                              >
                                {% render 'icon-media', icon: 'icon-3d-model' %}
                                {{ 'products.product.xr_button' | t }}
                              </button>
                            </div>
                          </div>
                      {% endcase %}
                    </div>
                  </div>
                {% endif %}
              {% endfor %} 
            </div>
          </div>
        </div>
      </template>
    {% endif %}
  </div>
</div>
<script src="{{ 'product-media.js' | asset_url }}" defer></script>